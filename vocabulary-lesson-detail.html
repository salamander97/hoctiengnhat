<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìñ Chi ti·∫øt b√†i h·ªçc - Minna no Nihongo</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/lesson-detail.css">
</head>

<body>
    <!-- Header Section -->
    <div class="lesson-header" id="lessonHeader">
        <a href="vocabulary-lessons.html" class="back-button">‚Üê V·ªÅ danh s√°ch b√†i h·ªçc</a>
        <div class="container">
            <div class="header-content">
                <div class="lesson-number-big" id="lessonNumberBig">1</div>
                <h1 id="lessonTitle">Gi·ªõi thi·ªáu b·∫£n th√¢n</h1>
                <p id="lessonTitleJp">Á¨¨1Ë™≤ÔºöËá™Â∑±Á¥π‰ªã</p>
                <div class="lesson-meta">
                    <span class="lesson-difficulty" id="lessonDifficulty">‚≠ê</span>
                    <span class="lesson-group" id="lessonGroup">Nh√≥m 1: C∆° b·∫£n</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container main-content">
        
        <!-- Loading State -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner"></div>
            <h4>ƒêang t·∫£i n·ªôi dung b√†i h·ªçc...</h4>
        </div>

        <!-- Lesson Options -->
        <div class="lesson-options" id="lessonOptions" style="display: none;">
            <h2>üéØ Ch·ªçn c√°ch h·ªçc</h2>
            <p class="options-description">B·∫°n mu·ªën h·ªçc b√†i n√†y nh∆∞ th·∫ø n√†o?</p>
            
            <div class="options-grid">
                
                <!-- Study Option -->
                <div class="option-card study-card" onclick="startStudy()">
                    <div class="option-icon">üìö</div>
                    <h3>H·ªçc t·ª´ v·ª±ng</h3>
                    <p>H·ªçc t·ª´ v·ª±ng th√¥ng qua flashcard t∆∞∆°ng t√°c v·ªõi h·ªá th·ªëng ghi nh·ªõ th√¥ng minh</p>
                    <div class="option-features">
                        <div class="feature-item">‚úÖ Flashcard hai m·∫∑t</div>
                        <div class="feature-item">‚úÖ √Çm thanh ph√°t √¢m</div>
                        <div class="feature-item">‚úÖ V√≠ d·ª• c√¢u th·ª±c t·∫ø</div>
                        <div class="feature-item">‚úÖ H·ªá th·ªëng ghi nh·ªõ</div>
                    </div>
                    <div class="option-button study-button">
                        üöÄ B·∫Øt ƒë·∫ßu h·ªçc
                    </div>
                </div>

                <!-- Quiz Option -->
                <div class="option-card quiz-card" onclick="startQuiz()">
                    <div class="option-icon">üìù</div>
                    <h3>L√†m Quiz</h3>
                    <p>Ki·ªÉm tra ki·∫øn th·ª©c t·ª´ v·ª±ng v·ªõi c√°c c√¢u h·ªèi tr·∫Øc nghi·ªám v√† b√†i t·∫≠p ƒëa d·∫°ng</p>
                    <div class="option-features">
                        <div class="feature-item">‚úÖ C√¢u h·ªèi tr·∫Øc nghi·ªám</div>
                        <div class="feature-item">‚úÖ G√µ t·ª´ ti·∫øng Nh·∫≠t</div>
                        <div class="feature-item">‚úÖ Nghe v√† ch·ªçn ƒë√°p √°n</div>
                        <div class="feature-item">‚úÖ X·∫øp h·∫°ng ƒëi·ªÉm s·ªë</div>
                    </div>
                    <div class="option-button quiz-button">
                        üéØ L√†m b√†i ki·ªÉm tra
                    </div>
                </div>

            </div>
        </div>

        <!-- Lesson Info -->
        <div class="lesson-info" id="lessonInfo" style="display: none;">
            <h2>üìã Th√¥ng tin b√†i h·ªçc</h2>
            
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-icon">üìö</div>
                    <div class="info-content">
                        <h4>T·ª´ v·ª±ng</h4>
                        <p id="vocabCount">ƒêang t·∫£i...</p>
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-icon">üìñ</div>
                    <div class="info-content">
                        <h4>Ng·ªØ ph√°p ch√≠nh</h4>
                        <p id="grammarPoint">ƒêang t·∫£i...</p>
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-icon">‚è±Ô∏è</div>
                    <div class="info-content">
                        <h4>Th·ªùi gian h·ªçc</h4>
                        <p id="studyTime">15-20 ph√∫t</p>
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-icon">üéØ</div>
                    <div class="info-content">
                        <h4>M·ª©c ƒë·ªô</h4>
                        <p id="difficultyText">C∆° b·∫£n</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preview Words -->
        <div class="preview-words" id="previewWords" style="display: none;">
            <h2>üëÄ Xem tr∆∞·ªõc t·ª´ v·ª±ng</h2>
            <p>M·ªôt s·ªë t·ª´ v·ª±ng ch√≠nh trong b√†i h·ªçc n√†y:</p>
            
            <div class="words-grid" id="wordsGrid">
                <!-- Sample words will be loaded here -->
            </div>
            
            <div class="preview-actions">
                <button class="btn btn-primary" onclick="startStudy()">üìö H·ªçc t·∫•t c·∫£ t·ª´ v·ª±ng</button>
                <button class="btn btn-success" onclick="startQuiz()">üìù L√†m Quiz ngay</button>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        class LessonDetailPage {
            constructor() {
                this.lessonId = this.getLessonIdFromUrl();
                this.lessonData = null;
                this.init();
            }

            init() {
                console.log(`üìñ Loading lesson ${this.lessonId}...`);
                
                if (!this.lessonId) {
                    this.showError('Kh√¥ng t√¨m th·∫•y b√†i h·ªçc!');
                    return;
                }

                this.loadLessonData();
            }

            getLessonIdFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                return parseInt(urlParams.get('lesson')) || null;
            }

            loadLessonData() {
                const userId = this.getCurrentUserId();
                
                fetch(`php/n5-lessons-api.php?action=getLessonDetail&lesson_id=${this.lessonId}&user_id=${userId}`)
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            this.lessonData = result.data;
                            this.renderLessonData();
                            this.hideLoading();
                            this.showContent();
                        } else {
                            throw new Error(result.error || 'Failed to load lesson data');
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Load lesson data error:', error);
                        this.showError(`Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu b√†i h·ªçc: ${error.message}`);
                    });
            }

            getCurrentUserId() {
                // Get user ID from auth - implement based on your auth system
                return 1; // Temporary - replace with actual user ID from session/auth
            }

            renderLessonData() {
                const lesson = this.lessonData;

                // Update header
                document.getElementById('lessonNumberBig').textContent = lesson.lesson_number;
                document.getElementById('lessonTitle').textContent = lesson.lesson_title;
                document.getElementById('lessonTitleJp').textContent = lesson.lesson_title_jp;
                document.getElementById('lessonDifficulty').textContent = '‚≠ê'.repeat(lesson.difficulty_level);
                document.getElementById('lessonGroup').textContent = this.getGroupName(lesson.lesson_number);
                
                // Update header color
                document.getElementById('lessonHeader').style.background = 
                    `linear-gradient(135deg, ${this.getGroupColor(lesson.lesson_number)} 0%, ${this.getGroupColor(lesson.lesson_number)}dd 100%)`;

                // Update lesson info
                document.getElementById('vocabCount').textContent = `${lesson.total_words} t·ª´ v·ª±ng`;
                document.getElementById('grammarPoint').textContent = lesson.grammar_points ? lesson.grammar_points.join(', ') : 'Ng·ªØ ph√°p N5 c∆° b·∫£n';
                document.getElementById('studyTime').textContent = `${lesson.estimated_time || 20} ph√∫t`;
                document.getElementById('difficultyText').textContent = this.getDifficultyText(lesson.difficulty_level);

                // Render sample words
                if (lesson.sample_words && lesson.sample_words.length > 0) {
                    this.renderSampleWords(lesson.sample_words);
                } else {
                    // Load sample words separately if not included
                    this.loadSampleWords();
                }
            }

            async loadSampleWords() {
                try {
                    const userId = this.getCurrentUserId();
                    const response = await fetch(`php/n5-lessons-api.php?action=getLessonVocabulary&lesson_id=${this.lessonId}&user_id=${userId}`);
                    const result = await response.json();
                    
                    if (result.success && result.data.vocabulary) {
                        const sampleWords = result.data.vocabulary.slice(0, 6).map(word => ({
                            jp: word.japanese_word,
                            meaning: word.vietnamese_meaning,
                            romaji: word.romaji
                        }));
                        this.renderSampleWords(sampleWords);
                    }
                } catch (error) {
                    console.error('‚ùå Error loading sample words:', error);
                }
            }

            getGroupName(lessonNumber) {
                if (lessonNumber <= 10) return "Nh√≥m 1: C∆° b·∫£n";
                if (lessonNumber <= 20) return "Nh√≥m 2: Trung c·∫•p";
                if (lessonNumber <= 30) return "Nh√≥m 3: N√¢ng cao";
                if (lessonNumber <= 40) return "Nh√≥m 4: Chuy√™n s√¢u";
                return "Nh√≥m 5: T·ªïng h·ª£p";
            }

            getDifficultyText(level) {
                switch(level) {
                    case 1: return "C∆° b·∫£n";
                    case 2: return "Trung c·∫•p";
                    case 3: return "N√¢ng cao";
                    case 4: return "Chuy√™n s√¢u";
                    case 5: return "T·ªïng h·ª£p";
                    default: return "C∆° b·∫£n";
                }
            }

            getGroupColor(lessonNumber) {
                if (lessonNumber <= 10) return "#56ab2f";
                if (lessonNumber <= 20) return "#4facfe";
                if (lessonNumber <= 30) return "#f093fb";
                if (lessonNumber <= 40) return "#ff9a8b";
                return "#667eea";
            }

            renderLessonData() {
                const lesson = this.lessonData;

                // Update header
                document.getElementById('lessonNumberBig').textContent = lesson.id;
                document.getElementById('lessonTitle').textContent = lesson.title;
                document.getElementById('lessonTitleJp').textContent = lesson.titleJp;
                document.getElementById('lessonDifficulty').textContent = lesson.difficulty;
                document.getElementById('lessonGroup').textContent = lesson.group;
                
                // Update header color
                document.getElementById('lessonHeader').style.background = 
                    `linear-gradient(135deg, ${lesson.color} 0%, ${lesson.color}dd 100%)`;

                // Update lesson info
                document.getElementById('vocabCount').textContent = lesson.vocabCount;
                document.getElementById('grammarPoint').textContent = lesson.grammarPoint;
                document.getElementById('studyTime').textContent = lesson.studyTime;
                document.getElementById('difficultyText').textContent = lesson.difficultyText;

                // Render sample words
                this.renderSampleWords(lesson.sampleWords);
            }

            renderSampleWords(words) {
                const grid = document.getElementById('wordsGrid');
                grid.innerHTML = words.map(word => `
                    <div class="word-preview-card">
                        <div class="word-jp">${word.jp}</div>
                        <div class="word-romaji">${word.romaji}</div>
                        <div class="word-meaning">${word.meaning}</div>
                    </div>
                `).join('');
            }

            showContent() {
                document.getElementById('lessonOptions').style.display = 'block';
                document.getElementById('lessonInfo').style.display = 'block';
                document.getElementById('previewWords').style.display = 'block';
            }

            hideLoading() {
                document.getElementById('loadingSpinner').style.display = 'none';
            }

            showError(message) {
                document.body.innerHTML = `
                    <div class="container mt-5 text-center">
                        <h2>‚ùå L·ªói</h2>
                        <p>${message}</p>
                        <a href="vocabulary-lessons.html" class="btn btn-primary">‚Üê V·ªÅ danh s√°ch b√†i h·ªçc</a>
                    </div>
                `;
            }
        }

        // Global functions
        function startStudy() {
            const lessonId = new URLSearchParams(window.location.search).get('lesson');
            window.location.href = `vocabulary-lesson-study.html?lesson=${lessonId}`;
        }

        function startQuiz() {
            const lessonId = new URLSearchParams(window.location.search).get('lesson');
            window.location.href = `vocabulary-lesson-quiz.html?lesson=${lessonId}`;
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            window.lessonDetailApp = new LessonDetailPage();
        });
    </script>
</body>

</html>
